FROM debian:buster-slim
MAINTAINER Addison Crump "addisoncrump@tamu.edu"

COPY headless_handler.sh /usr/bin/headless_handler.sh
COPY server.sh /usr/bin/server.sh
COPY flag2.txt /root/flag.txt

RUN apt update; apt -y --autoremove full-upgrade
RUN apt -y install libgpm2 libtinfo5 lsb-base netcat python3 socat screen sudo wget xxd
RUN cd /tmp; \
      wget https://snapshot.debian.org/archive/debian/20190501T041322Z/pool/main/v/vim/vim-common_8.1.0875-2_all.deb; dpkg -i vim-common_8.1.0875-2_all.deb; \
      wget https://snapshot.debian.org/archive/debian/20190501T041322Z/pool/main/v/vim/vim-runtime_8.1.0875-2_all.deb; dpkg -i vim-runtime_8.1.0875-2_all.deb; \
      wget https://snapshot.debian.org/archive/debian/20190501T041322Z/pool/main/v/vim/vim_8.1.0875-2_amd64.deb; dpkg -i vim_8.1.0875-2_amd64.deb
RUN apt-get autoremove
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN echo ":set modeline" >> /etc/vim/vimrc

RUN bash -c "useradd -m -p $(python3 -c 'import crypt; print(crypt.crypt("c18317973315befdec209dbbce0222d4c0e65b14c2316dc1302e5cfcfabd23a8"))') -s /bin/bash mwazowski"
COPY note_to_self.txt /home/mwazowski/note_to_self.txt
COPY flag1.txt /home/mwazowski/flag.txt
RUN apt-mark showmanual > /home/mwazowski/manually_installed_packages.txt
RUN echo "mwazowski ALL=NOPASSWD: /usr/bin/apt" >> /etc/sudoers
RUN rm -f /root/.bash_history

CMD ["su", "mwazowski", "-c", "/usr/bin/server.sh"]
