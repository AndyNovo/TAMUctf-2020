FROM gcc as build
ADD http://www.nazgul.ch/dev/nostromo-1.9.6.tar.gz /tmp/nostromo-1.9.6.tar.gz
RUN tar -xvzf /tmp/nostromo-1.9.6.tar.gz -C /tmp

RUN apt-get update
RUN apt-get install groff man-db hugo -y

WORKDIR /tmp/nostromo-1.9.6
RUN make

COPY website_source /tmp/website_source

WORKDIR /tmp/website_source

RUN hugo

FROM ubuntu:18.04

RUN apt update
RUN apt -y install cron netcat make libssl-dev wget

COPY --from=build /tmp/nostromo-1.9.6 /tmp/nostromo-1.9.6
WORKDIR /tmp/nostromo-1.9.6

RUN make install
RUN sed -i 's/_nostromo/webserver/' /tmp/nostromo-1.9.6/conf/nhttpd.conf-dist
RUN sed -i 's/www.nazgul.ch/localhost/' /tmp/nostromo-1.9.6/conf/nhttpd.conf-dist
RUN cp /tmp/nostromo-1.9.6/conf/nhttpd.conf-dist /var/nostromo/conf/nhttpd.conf
RUN rm -rf /tmp/nostromo-1.9.6
RUN useradd webserver -d /var/nostromo/htdocs
RUN chown -R webserver:daemon /var/nostromo/*

RUN echo "* * * * * root /usr/bin/healthcheck" >> /etc/crontab

COPY healthcheck.sh /usr/bin/healthcheck
COPY start.sh /tmp/start.sh

RUN chmod 777 /usr/bin/healthcheck

COPY flag.txt /root/flag.txt

COPY --from=build /tmp/website_source/public /var/nostromo/htdocs


ENTRYPOINT ["bash","/tmp/start.sh"]
