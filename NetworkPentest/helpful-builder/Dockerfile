FROM adoptopenjdk/openjdk12:alpine-slim

RUN apk add --no-cache --update python3 netcat-openbsd
RUN adduser jsullivan --disabled-password

EXPOSE 8000
EXPOSE 9000

COPY helpful-builder/ /home/jsullivan/helpful-builder
COPY run.sh /home/jsullivan/run.sh

RUN chown -hR jsullivan:jsullivan /home/jsullivan

# pre-download gradle so contestants don't need to wait
RUN su -s /bin/sh -c "cd /home/jsullivan/helpful-builder; sh gradlew --continue clean build || true" jsullivan

WORKDIR /home/jsullivan

COPY flag.txt /home/jsullivan/flag.txt

CMD ["su", "-s", "/bin/sh", "-c", "cd helpful-builder; python3 -m http.server & cd .. && sh run.sh", "jsullivan"]
