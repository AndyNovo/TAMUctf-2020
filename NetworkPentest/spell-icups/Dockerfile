FROM debian:buster-slim
MAINTAINER Addison Crump "addisoncrump@tamu.edu"

RUN apt update; apt -y --autoremove full-upgrade; apt -y install socat

ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups/cups_2.0.2-2_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups/libcups2_2.0.2-2_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups/libcupscgi1_2.0.2-2_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups/libcupsmime1_2.0.2-2_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups/libcupsppdc1_2.0.2-2_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups/libcupsimage2_2.0.2-2_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups/cups-core-drivers_2.0.2-2_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups/cups-daemon_2.0.2-2_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups/cups-client_2.0.2-2_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups-filters/cups-filters_1.0.67-1_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups-filters/cups-filters-core-drivers_1.0.67-1_amd64.deb /tmp/
ADD https://snapshot.debian.org/archive/debian/20150501T042823Z/pool/main/c/cups-pdf/cups-pdf_2.6.1-6_amd64.deb /tmp/
ADD http://security.debian.org/debian-security/pool/updates/main/p/poppler/libpoppler46_0.26.5-2+deb8u13_amd64.deb /tmp/
ADD http://http.us.debian.org/debian/pool/main/q/qpdf/libqpdf13_5.1.2-2_amd64.deb /tmp/
ADD http://security.debian.org/debian-security/pool/updates/main/g/gnutls28/libgnutls-deb0-28_3.3.30-0+deb8u1_amd64.deb /tmp/
ADD http://http.us.debian.org/debian/pool/main/n/nettle/libhogweed2_2.7.1-5+deb8u2_amd64.deb /tmp/
ADD http://http.us.debian.org/debian/pool/main/n/nettle/libnettle4_2.7.1-5+deb8u2_amd64.deb /tmp/
ADD http://http.us.debian.org/debian/pool/main/o/openjpeg/libopenjpeg5_1.5.2-3_amd64.deb /tmp/
ADD http://http.us.debian.org/debian/pool/main/libp/libpng/libpng12-0_1.2.50-2+deb8u3_amd64.deb /tmp/

RUN apt -yf install /tmp/*.deb
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN cupsd; cupsctl --remote-admin --remote-any --share-printers; killall cupsd

RUN sed -i 's/#AnonUser/AnonUser/g' /etc/cups/cups-pdf.conf

COPY flag.txt /root/flag.txt

EXPOSE 631
ENTRYPOINT ["/bin/bash", "-c", "cupsd; lpadmin -p pdf -E -m lsb/usr/cups-pdf/CUPS-PDF.ppd; sleep infinity"]
